---
title: "Examen_I_G2-C38600-Erika_Wu_Liang"
format: html
editor: visual
---

Descargas y referencias [Mapply](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/mapply) [Sapply](https://r-coder.com/funcion-sapply-en-r/) [Comprensión mayor de los plot](https://cran.r-project.org/doc/manuals/r-release/R-intro.html) [Plot()](https://bookdown.org/jboscomendoza/r-principiantes4/la-funcion-plot.html) [Cat](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/cat) [setdiff](https://www.rdocumentation.org/packages/prob/versions/1.0-1/topics/setdiff) [collapse](https://www.geeksforgeeks.org/r-language/collapse-function-in-r/)

```{r}
library(tidyverse)
library(ggplot2)
```

Riesgo cardiovascular #1. Descargas

```{r}
datos.pacientes <- read_excel("/Users/erika/Downloads/Datos_Pacientes_EI.xlsx")
beta.hombres <- read_excel("/Users/erika/Downloads/Datos_Pacientes_EI.xlsx", sheet = 2)
beta.mujeres <- read_excel("/Users/erika/Downloads/Datos_Pacientes_EI.xlsx", sheet = 3)

head(datos.pacientes)
beta.hombres
beta.mujeres
```

#2. Medias por genero y factores de riesgo

```{r}
medias.riesgo <- datos.pacientes %>%
  group_by(sexo) %>%
  summarise(
    cantidad = n(),
    edad= mean(edad, is.na = TRUE),
    col_total = mean(col_total, is.na = TRUE),
    hdl = mean(hdl, is.na = TRUE),
    pas = mean(pas, is.na = TRUE),
    tratamiento = mean(tratamiento, is.na = TRUE),
    fumador = mean(fumador, is.na = TRUE),
    diabetes = mean(diabetes, is.na = TRUE)
  ) 
medias.riesgo
```

#3. Función calcular riesgo cardiovascular

```{r}
#Comencemos con la función
f.riesgo <- function(sexo, edad, col_total, hdl, pas, tratamiento, fumador, diabetes) {
  So.mujeres <- 0.95012
  So.hombres <- 0.88936
  #Dividirlo por medio del sexo 
  if (sexo == 0) { #Caso mujeres
    betas <- beta.mujeres      
    media <- medias.riesgo[medias.riesgo$sexo == 0, ]
    So_t <- So.mujeres 
  } else {
    betas <- beta.hombres #Caso hombres
    media <- medias.riesgo[medias.riesgo$sexo == 1, ]
    So_t <- So.hombres
  }
  x <- c(edad = edad, 
         col_total = col_total, 
         hdl = hdl, 
         pas = pas, 
         tratamiento = tratamiento, 
         fumador = fumador, 
         diabetes = diabetes
         )
  #Divido el trabajo, primero haciendo el calculo del indice lineal (L)
  L <- 0
  for (i in 1:nrow(betas)) {
    var <- betas$variable[i]
    if (var %in% names(x)) {
      L <- L + betas$beta[i] * (x[var] - as.numeric(media[[var]]))
    }
  }
  # Ahora si tengo la formula completa
  riesgo <- 1 - (So_t)^(exp(L))
  return(riesgo)
}
#Riesgo para toda la tabla y crear una nueva columna con el riesgo
datos.pacientes$riesgo <- mapply(
  f.riesgo,
  sexo = datos.pacientes$sexo,
  edad = datos.pacientes$edad,
  col_total = datos.pacientes$col_total,
  hdl = datos.pacientes$hdl,
  pas = datos.pacientes$pas,
  tratamiento = datos.pacientes$tratamiento,
  fumador = datos.pacientes$fumador,
  diabetes = datos.pacientes$diabetes
)

# Mostrar los primeros resultados y caso especifico 
head(datos.pacientes) 
datos.pacientes %>% filter(id == 1)

## Aqui podemos ver que como esta persona es mujer y como no es fumador ni diabetico entonces no ocupa tratamiento y eso la deja con un riesgo relativamente bajo para ella y esta considerada a un nivel saludable 
```

Manipulación de Datos

```{r}
datos <- read_csv("/Users/erika/Downloads/datos_parte2.csv")
head(datos)
```

#1. Contar faltantes en cada columna y sus porcentajes

```{r}
Faltantes <- colSums(is.na(datos)) / nrow(datos) * 100
Faltantes
```

#2.Agregar la variable tipo fecha

```{r}
datos$fecha <- as.Date(ISOdate(datos$year, datos$month, datos$day))
head(datos)
class(datos$fecha)
```

#3.Gráfico de cada una de lsa variables numericas

```{r}
# Determinar estación del año
datos$estacion <- case_when(
  datos$month %in% c(1, 2 ,12) ~ "Invierno",
  datos$month %in% c(3, 4, 5) ~ "Primavera",
  datos$month %in% c(6, 7, 8) ~ "Verano",
  TRUE ~ "Otoño" #c(9, 10, 11)
)

#Verificar cuales son numericos
str(datos) 

# Función para graficar todas las numéricas
graf.num <- function(df) {
  numericas <- names(df)[sapply(df, is.numeric)]
  #Caja de bigotes 
  for (variable in numericas) {
    g <- ggplot(df) +
      geom_boxplot(aes(x = estacion, y = df[[variable]], fill = estacion)) +
      labs(
        title = paste(variable, "por estación"), 
        x = "Estación del año",
        y = variable
      ) +
      theme_minimal() 
    print(g)
  }
}
graf.num(datos)
```

#4. Función

```{r}
#Puede ser un data frame cuaalquiera
f <- function(df) {
  #Identificar variables numéricas
  num_vars <- names(df)[sapply(df, is.numeric)]
  cat("Variables numéricas:", num_vars)
  
  #Imputar valores faltantes (Estrategia: usar la media)
  for (var in num_vars) {
    media <- mean(df[[var]], na.rm = TRUE)
    imputados <- is.na(df[[var]])
    df[[var]][imputados] <- media
    
    #Graficar con color distinto los imputados y uso de plot() para quedarnos en base de R
    plot(df[[var]], 
         main = paste("Gráfico de", var),
         ylab = var,
         # Rojo para valores imputados al df y azul para los valores originales
         col = ifelse(imputados, "red", "blue"),
    legend("topright", 
           legend = c("Imputado", "Original"),
           col = c("red", "blue"))
    )
  }
  # Retorna el data frame imputado
  return(df)
}
#Ejemplo de uso:
# df_falso <- f(df_falso)
```

#5. Funcion con lm

```{r}
#Mío en base al ejemplo, está en desorden pero sigue el ejemplo
imputar_lm <- function(df) {  
  num.variables <- names(df)[sapply(df, is.numeric)]
  for (variables in num.variables) {
    y <- df[[variables]]
    indices_na <- which(is.na(y))
    predicto <- setdiff(num.variables, variables)
    
    if (length(predicto) == 0) {
      # Si no hay predictores, usa la media
      df[[variables]][indices_na] <- mean(y, na.rm = TRUE)
    } else {
      # Fórmula del modelo
      formula_modelo <- as.formula(
        paste0(variables, " ~ ", paste(predicto, collapse = " + "))
      )
      
      # Entrenar modelo
      modelo_lm <- lm(formula_modelo, data = df, subset = complete.cases(df[, c(variables, predicto)]))
      
      # Predecir e imputar
      df[[variables]][indices_na] <- predict(modelo_lm, newdata = df[indices_na, ])
    }
    
    colores <- rep("blue", length(y))
    colores[indices_na] <- "red"
    
    # Gráfico
    plot(df[[variables]],
         main = paste("Imputación por regresión lineal:", variables),
         ylab = variables,
         col = colores,
         )
    legend("topright", legend = c("Imputado", "Original"),
           col = c("red", "blue"))
  }
  #Retorna dataframe imputado
  return(df)
}

```

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
1 + 1
```

You can add options to executable code like this

```{r}
#| echo: false
2 * 2
```

The `echo: false` option disables the printing of code (only output is displayed).
